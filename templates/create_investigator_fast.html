{% extends "base.html" %}

{% from "macros/forms.html" import stat_field, stat_value, textarea_field %}

{% block title %}Call of Cthulhu | Классическое создание персонажа{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/create_classic.css') }}">
{% endblock %}

{% block body %}
<div class="tentacles-container">
    <div class="tentacle tentacle-bg-1"></div>
    <div class="tentacle tentacle-bg-2"></div>
    <div class="tentacle tentacle-bg-3"></div>
    <div class="tentacle tentacle-bg-4"></div>
</div>

<div class="container">
    <header>
        <h1 class="logo">CALL OF CTHULHU</h1>
        <div class="subtitle">Классическое создание исследователя</div>
    </header>

    <!-- Прогресс -->
    <div class="progress-container">
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        <div class="progress-steps">
            <span class="step active" data-step="1">Профессия</span>
            <span class="step" data-step="2">Характеристики</span>
            <span class="step" data-step="3">Возраст</span>
            <span class="step" data-step="4">Навыки</span>
            <span class="step" data-step="5">Удача</span>
            <span class="step" data-step="6">Внешность</span>
        </div>
    </div>

    <form id="characterForm" class="character-form" action="/" method="POST">

        <!-- Шаг 1: Профессия -->
        <div class="form-step active" data-step="1">
            <h2>Шаг 1: Выбор профессии</h2>

            <div class="profession-card">
                <div class="card-header">
                    <div class="form-group full-width">
                        <label for="profession">Профессия:</label>
                        <input type="text" id="profession" name="profession" required placeholder="Введите профессию вашего исследователя">
                    </div>
                </div>

                <div class="card-section">
                    <h3 class="section-title">8 профессиональных навыков</h3>
                    <div class="counter">
                        Выбрано навыков: <span id="skillsCounter">0</span> / 8
                    </div>
                    <div class="selected-skills-list" id="selectedSkillsList"></div>
                </div>
            </div>

            <h3 class="section-title full-width">Выберите 8 профессиональных навыков</h3>

            <div class="skills-container full-width">
                {% for category, skills in context.skills.items() %}
                {% if category not in ['Мифы Ктулху', 'Финансы'] %}
                <div class="skill-category">
                    <h3>{{ category }}</h3>
                    {% for skill in skills %}
                        <div class="skill-item">
                            <input type="checkbox" id="skill_{{ skill.id }}" name="skills" value="{{ skill.id }} " data-name="{{ skill.rus }}">
                            <label for="skill_{{ skill.id }}">{{ skill.rus }} ({{ skill.base }})</label>
                        </div>
                    {% endfor %}
                </div>
                {% endif %}
                {% endfor %}
            </div>
        </div>

        <!-- Шаг 2: Характеристики -->
        <div class="form-step" data-step="2">
            <h2>Шаг 2: Характеристики персонажа</h2>

            <div class="points-container">
                <div class="points-info">
                    <p>Перетащите значения в нужные характеристики</p>
                </div>
            </div>
        
            <div class="stat-pool" id="statPool">
                <div class="stat-number" draggable="true">80</div>
                <div class="stat-number" draggable="true">70</div>
                <div class="stat-number" draggable="true">60</div>
                <div class="stat-number" draggable="true">60</div>
                <div class="stat-number" draggable="true">50</div>
                <div class="stat-number" draggable="true">50</div>
                <div class="stat-number" draggable="true">50</div>
                <div class="stat-number" draggable="true">40</div>
            </div>
        
            <div class="stats-grid" id="statTargets">
                {% for ch in context.characteristic %}
                <div class="stat-group droppable" data-stat="{{ ch.id }}">
                    <label>{{ ch.rus }} ({{ ch.eng }})</label>
                    <div class="stat-dropzone">Перетащите сюда</div>
                    <input type="hidden" name="characteristics[{{ ch.id }}]" value="">
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Шаг 3: Возраст -->
        <div class="form-step" data-step="3">
            <h2>Шаг 3: Выбор возраста</h2>

            <div class="form-group">
                <label for="ageRange">Возрастная категория:</label>
                <select id="ageRange" name="ageRange" required>
                    <option value="">-- Выберите возраст --</option>
                    {% for age_option in context.age %}
                        <option value="{{ age_option.id }}">{{ age_option.rus }}</option>
                    {% endfor %}
                </select>
            </div>

            <div id="ageModifiersInfo" class="info-box" style="display: none;">
                <h3 class="section-title">Модификаторы возраста</h3>
                <div id="modifiersList"></div>
            </div>

            <h3 class="highlight-title">Текущие характеристики</h3>
            <div class="stats-grid">
                {% for ch in context.characteristic %}
                    {{ stat_value(ch.rus ~ " (" ~ ch.eng ~ ")", ch.id, 0) }}
                {% endfor %}
            </div>

            <div id="eduImprovementSection" class="edu-section" style="display: none;">
                <h3 class="section-title">Проверка улучшения образования</h3>
                <p>Осталось проверок: <span id="eduImprovement">0</span></p>
                <p>Текущее ОБР: <span id="currentEDU">15</span></p>
                <button type="button" id="rollEduImprovement" class="nav-btn center">
                    Бросить кубик для улучшения ОБР
                </button>
                <div id="eduImprovementResult" class="text-center"></div>
            </div>
        </div>
        <div id="agePenaltyPopup" class="popup" style="display:none;">
          <div class="popup-content">
            <h3>Распределите возрастной штраф</h3>
            <p>Вам нужно распределить <span id="agePenaltyTotal"></span> штрафных очков между СИЛ, ЛВК и ТЕЛ</p>

            <div class="penalty-fields">
              {{ stat_field("penalty_str", "Сила (STR)", 0, 0, 0, "stat-btn penalty-btn") }}
              {{ stat_field("penalty_dex", "Ловкость (DEX)", 0, 0, 0, "stat-btn penalty-btn") }}
              {{ stat_field("penalty_con", "Телосложение (CON)", 0, 0, 0, "stat-btn penalty-btn") }}
            </div>

            <p>Осталось распределить: <span id="agePenaltyRemaining"></span></p>

            <div class="popup-buttons">
              <button type="button" id="applyAgePenalty" class="popup-btn">Применить штрафы</button>
            </div>
          </div>
        </div>

        <!-- Шаг 4: Навыки -->
        <div class="form-step" data-step="4">
            <h2>Шаг 4: Распределение навыков</h2>
            <div id="step_4_formula_wait">
                <div class="points-container">
                    <div class="points-info">
                        <p id="skillPointsMax">Распределите все значения по навыкам</p>
                    </div>
                </div>

                <div class="statPoolSkill" id="statPoolSkill">
                    <div class="stat-number" draggable="true">70</div>
                    <div class="stat-number" draggable="true">60</div>
                    <div class="stat-number" draggable="true">60</div>
                    <div class="stat-number" draggable="true">50</div>
                    <div class="stat-number" draggable="true">50</div>
                    <div class="stat-number" draggable="true">50</div>
                    <div class="stat-number" draggable="true">40</div>
                    <div class="stat-number" draggable="true">40</div>
                    <div class="stat-number" draggable="true">40</div>
                </div>

                <div class="skills-container-skill-fast" id="skill_distribution">
                    {% for category, skills in context.skills.items() %}
                    <div class="skill-category-skill">
                        <h3>{{ category }}</h3>
                        {% for skill in skills %}
                            <div class="stat-group droppable" data-stat="{{ skill.id }}">
                                <label data-name="{{ skill.rus }}">{{ skill.rus }} ({{ skill.base }})</label>
                                <div class="stat-dropzone">Перетащите сюда</div>
                                <input type="hidden" name="skill[{{ skill.id }}]" value="">
                            </div>
                        {% endfor %}
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Шаг 5: Снаряжение -->
        <div class="form-step" data-step="5">
            <h2>Шаг 5: Определение удачи</h2>

            <div class="dice-roll-section">
                <p id="luckTryNum">Бросков удачи <strong >1</strong></p>
                <button type="button" id="rollLuck" class="nav-btn center">
                    Бросить кубики для определения удачи
                </button>
                <div id="luckRollResult" class="text-center"></div>
            </div>

            <input type="hidden" id="luckValue" name="luck" value="0">
        </div>

        <!-- Шаг 6: Внешность -->
        <div class="form-step" data-step="6">
            <h2>Шаг 6: Внешность и личные детали</h2>
            {{ textarea_field("charName", "Имя", "Твоё имя...", 1) }}
            {{ textarea_field("appearanceDesc", "Внешность", "Опишите внешность вашего исследователя...", 3) }}
            {{ textarea_field("backstory", "Предыстория", "Расскажите предысторию вашего исследователя...", 4) }}
            {{ textarea_field("equipment", "Снаряжение", "Опишите снаряжение вашего исследователя...", 6) }}
        </div>

        <!-- Кнопки навигации -->
        <div class="navigation-buttons">
            <button type="button" id="prevBtn" class="nav-btn">Назад</button>
            <button type="button" id="nextBtn" class="nav-btn">Далее</button>
            <button type="submit" id="submitBtn" class="nav-btn" style="display: none;">Завершить создание</button>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/create_fast.js') }}"></script>
{% endblock %}


