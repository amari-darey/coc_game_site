<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CoC7 — 1920s Investigator Sheet (HTML + JS)</title>
  <style>
    :root {
      --bg: #fbfbfb;
      --ink: #111;
      --muted: #666;
      --line: #ddd;
      --accent: #0b6ef6;
    }
    html, body { background: var(--bg); color: var(--ink); font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif; }
    * { box-sizing: border-box; }
    .sheet {
      max-width: 1000px; margin: 24px auto; background: white; padding: 20px; border: 1px solid var(--line); box-shadow: 0 6px 16px rgba(0,0,0,.06);
    }
    h1 { font-size: 20px; margin: 0 0 12px; letter-spacing: .5px; }
    h2 { font-size: 16px; margin: 20px 0 8px; border-bottom: 2px solid var(--ink); padding-bottom: 4px; }
    small.muted { color: var(--muted); }

    .grid { display: grid; gap: 10px; }
    .grid.cols-2 { grid-template-columns: 1fr 1fr; }
    .grid.cols-3 { grid-template-columns: repeat(3, 1fr); }
    .grid.cols-4 { grid-template-columns: repeat(4, 1fr); }

    label { font-size: 12px; color: var(--muted); display: block; margin-bottom: 2px; }
    input[type="text"], input[type="number"], select, textarea {
      width: 100%; border: 1px solid var(--line); padding: 8px; border-radius: 8px; font: inherit; background: #fff; color: var(--ink);
    }
    input[type="number"] { text-align: center; }

    .card { border: 1px solid var(--line); border-radius: 12px; padding: 12px; background: #fff; }
    .row { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 8px; align-items: end; }

    .char-grid { display: grid; grid-template-columns: repeat(9, 1fr); gap: 8px; }
    .char { border: 1px solid var(--line); border-radius: 12px; padding: 8px; text-align: center; }
    .char .name { font-size: 11px; color: var(--muted); }
    .char .vals { display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; margin-top: 4px; }
    .char input { text-align: center; }
    .subval { font-size: 10px; color: var(--muted); }

    table { width: 100%; border-collapse: collapse; }
    th, td { border: 1px solid var(--line); padding: 6px; font-size: 12px; text-align: center; }
    th { background: #f6f6f8; }

    .toolbar { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 14px; }
    .btn { border: 1px solid var(--line); background: #fff; padding: 8px 12px; border-radius: 10px; cursor: pointer; font: inherit; }
    .btn.primary { background: var(--accent); color: #fff; border-color: var(--accent); }

    .checkbox { display: flex; align-items: center; gap: 8px; }
    .pill { display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px; border: 1px solid var(--line); border-radius: 999px; font-size: 12px; }

    .muted-note { font-size: 12px; color: var(--muted); margin-top: 6px; }

    @media print {
      body { background: #fff; }
      .sheet { box-shadow: none; border: none; margin: 0; padding: 10mm; }
      .toolbar { display: none; }
      a[href]::after { content: ""; }
    }
  </style>
</head>
<body>
  <div class="sheet" id="sheet">
    <h1>1920s ERA INVESTIGATOR — Call of Cthulhu 7e</h1>
    <small class="muted">Веб-версия поля для заполнения. Печатный формат, автосохранение и экспорт/импорт поддерживаются.</small>

    <h2>Основная информация</h2>
    <div class="grid cols-3">
      <div class="card"><label>Имя</label><input id="name" type="text"/></div>
      <div class="card"><label>Профессия</label><input id="occupation" type="text"/></div>
      <div class="card"><label>Место жительства</label><input id="residence" type="text"/></div>
      <div class="card"><label>Место рождения</label><input id="birthplace" type="text"/></div>
      <div class="card"><label>Возраст</label><input id="age" type="number" min="1" max="120"/></div>
      <div class="card"><label>Местоимения</label><input id="pronoun" type="text" placeholder="он/она/они"/></div>
    </div>

    <h2>Характеристики</h2>
    <div class="char-grid" id="chars">
      <!-- 9 базовых характеристик -->
    </div>
    <div class="grid cols-4" style="margin-top:10px;">
      <div class="card"><label>Ловкость (Уклонение) — половина ЛОВ</label><input id="dodge" type="number" min="0" max="99" /></div>
      <div class="card"><label>Передвижение (MOV)</label><input id="mov" type="number" min="1" max="20"/></div>
      <div class="card"><label>Телосложение (Build)</label><input id="build" type="text" placeholder="введите"/></div>
      <div class="card"><label>Бонус урона (DB)</label><input id="db" type="text" placeholder="например, +1d4"/></div>
    </div>

    <h2>Ресурсы</h2>
    <div class="grid cols-4">
      <div class="card"><label>Здоровье HP (текущ./макс.)</label><div class="row"><input id="hp_current" type="number" min="0"><input id="hp_max" type="number" min="0"><input readonly value="HP"/></div></div>
      <div class="card"><label>Магия MP (текущ./макс.)</label><div class="row"><input id="mp_current" type="number" min="0"><input id="mp_max" type="number" min="0"><input readonly value="MP"/></div></div>
      <div class="card"><label>Удача (текущ./старт.)</label><div class="row"><input id="luck_current" type="number" min="0"><input id="luck_start" type="number" min="0"><input readonly value="Luck"/></div></div>
      <div class="card"><label>Рассудок SAN (текущ./макс.)</label><div class="row"><input id="san_current" type="number" min="0"><input id="san_max" type="number" min="0"><input readonly value="SAN"/></div></div>
    </div>

    <div class="grid cols-4" style="margin-top:8px;">
      <div class="pill"><input id="flag_temp_ins" type="checkbox"/> Временное помешательство</div>
      <div class="pill"><input id="flag_indef_ins" type="checkbox"/> Бессрочное помешательство</div>
      <div class="pill"><input id="flag_major_wound" type="checkbox"/> Тяжёлая рана</div>
      <div class="pill"><input id="flag_dying" type="checkbox"/> При смерти</div>
    </div>

    <h2>Навыки</h2>
    <div class="card">
      <table id="skills">
        <thead>
          <tr>
            <th style="text-align:left">Навык</th>
            <th>База</th>
            <th>Текущ.</th>
            <th>1/2</th>
            <th>1/5</th>
            <th>✓</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="toolbar">
        <button class="btn" id="add-art">+ Art/Craft</button>
        <button class="btn" id="add-lang">+ Language (Other)</button>
        <button class="btn" id="add-sci">+ Science</button>
        <button class="btn" id="add-fight">+ Fighting (spec.)</button>
        <span class="muted-note">Базовые значения навыков предзаполнены согласно листу-оригиналу.</span>
      </div>
    </div>

    <h2>Оружие</h2>
    <div class="card">
      <table id="weapons">
        <thead>
          <tr>
            <th>Название</th><th>Навык%</th><th>Урон</th><th>Дист.</th><th>Атк/раунд</th><th>Боезапас</th><th>Осечка</th><th></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="toolbar">
        <button class="btn" id="add-weapon">+ Добавить оружие</button>
      </div>
    </div>

    <div class="toolbar">
      <button class="btn primary" id="print">Печать</button>
      <button class="btn" id="reset">Сбросить</button>
      <button class="btn" id="export">Экспорт JSON</button>
      <input type="file" id="importFile" accept="application/json" style="display:none" />
      <button class="btn" id="import">Импорт JSON</button>
      <span class="muted-note">Автосохранение в браузер включено.</span>
    </div>

  </div>

  <script>
  // === Core model ===
  const CHAR_LIST = [
    { key: 'STR', label: 'СИЛ (STR)' },
    { key: 'DEX', label: 'ЛОВ (DEX)' },
    { key: 'INT', label: 'ИНТ (INT)' },
    { key: 'CON', label: 'ТЕЛ (CON)' },
    { key: 'APP', label: 'ВНЕ (APP)' },
    { key: 'POW', label: 'СИЛВ (POW)' },
    { key: 'SIZ', label: 'РАЗМ (SIZ)' },
    { key: 'EDU', label: 'ОБР (EDU)' },
    { key: 'MOV', label: 'ПЕР (MOV)' },
  ];

  // Base skills (from the 1920s investigator sheet fields list)
  const BASE_SKILLS = [
    ['Accounting',5],['Anthropology',1],['Archaeology',1],['Appraise',5],
    ['Charm',15],['Climb',20],['Credit Rating',0],['Cthulhu Mythos',0],
    ['Disguise',5],['Dodge','DEX/2'],['Drive Auto',20],['Elec. Repair',10],
    ['Fast Talk',5],['Fighting (Brawl)',25],['Firearms (Handgun)',20],
    ['Firearms (Rifle/Shotgun)',25],['First Aid',30],['History',5],
    ['Intimidate',15],['Jump',20],['Language (Own)', 'EDU'],['Law',5],
    ['Library Use',20],['Listen',20],['Locksmith',1],['Mech. Repair',10],
    ['Medicine',1],['Natural World',10],['Navigate',10],['Occult',5],
    ['Persuade',10],['Psychology',10],['Ride',5],['Sleight of Hand',10],
    ['Spot Hidden',25],['Stealth',20],['Survival',10],['Swim',20],
    ['Throw',20],['Track',10]
  ];

  const storageKey = 'coc7_sheet_v1';

  // === Render characteristics ===
  const charsRoot = document.getElementById('chars');
  CHAR_LIST.forEach(ch => {
    const el = document.createElement('div');
    el.className = 'char';
    el.innerHTML = `
      <div class="name">${ch.label}</div>
      <div class="vals">
        <input type="number" min="0" max="99" id="${ch.key}" placeholder="0" />
        <div class="subval"><span id="${ch.key}_half">½</span></div>
        <div class="subval"><span id="${ch.key}_fifth">⅕</span></div>
      </div>`;
    charsRoot.appendChild(el);
  });

  function half(x){ return Math.floor((x||0)/2); }
  function fifth(x){ return Math.floor((x||0)/5); }

  function updateDerived() {
    const DEX = num('DEX');
    const EDU = num('EDU');
    // Update halves & fifths for all characteristics
    CHAR_LIST.forEach(({key}) => {
      const val = num(key);
      byId(key+'_half').textContent = half(val);
      byId(key+'_fifth').textContent = fifth(val);
    });
    // Dodge = DEX/2 by default
    const dodge = document.getElementById('dodge');
    if (dodge && (dodge.dataset.manual!=='1')) dodge.value = half(DEX);
    // Language (Own) base = EDU
    updateAllSkillHalves();
    document.querySelectorAll('[data-skill]')
      .forEach(row => recomputeSkillRow(row));
  }

  function byId(id){ return document.getElementById(id); }
  function num(id){ return parseInt(byId(id)?.value,10)||0; }

  // === Skills table ===
  const skillsTbody = document.querySelector('#skills tbody');

  function baseFormulaToNumber(formula){
    if (typeof formula === 'number') return formula;
    if (formula === 'DEX/2') return half(num('DEX'));
    if (formula === 'EDU') return num('EDU');
    return 0;
  }

  function skillRow(label, base){
    const tr = document.createElement('tr');
    tr.dataset.skill = label;
    tr.innerHTML = `
      <td style="text-align:left"><input type="text" value="${label}" class="skill-name"/></td>
      <td><input type="number" class="skill-base" value="${baseFormulaToNumber(base)}" data-formula="${base}"></td>
      <td><input type="number" class="skill-now" value="${baseFormulaToNumber(base)}"></td>
      <td class="skill-half">${half(baseFormulaToNumber(base))}</td>
      <td class="skill-fifth">${fifth(baseFormulaToNumber(base))}</td>
      <td><input type="checkbox" class="skill-tick"></td>
    `;
    // listeners
    tr.querySelector('.skill-base').addEventListener('input', () => recomputeSkillRow(tr));
    tr.querySelector('.skill-now').addEventListener('input', () => recomputeSkillRow(tr,false));
    tr.querySelector('.skill-name').addEventListener('input', persist);
    tr.querySelector('.skill-tick').addEventListener('change', persist);
    return tr;
  }

  function recomputeSkillRow(tr, fromBase=true){
    const baseInput = tr.querySelector('.skill-base');
    const nowInput = tr.querySelector('.skill-now');
    const base = parseInt(baseInput.value,10)||0;
    if (fromBase && nowInput.dataset.manual!=='1') nowInput.value = base;
    tr.querySelector('.skill-half').textContent = half(parseInt(nowInput.value,10)||0);
    tr.querySelector('.skill-fifth').textContent = fifth(parseInt(nowInput.value,10)||0);
    persist();
  }

  function addWeaponRow(data={}){
    const tb = document.querySelector('#weapons tbody');
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input type="text" value="${data.name||''}"></td>
      <td><input type="number" value="${data.skill||''}"></td>
      <td><input type="text" value="${data.damage||''}"></td>
      <td><input type="text" value="${data.range||''}"></td>
      <td><input type="text" value="${data.attacks||''}"></td>
      <td><input type="text" value="${data.ammo||''}"></td>
      <td><input type="text" value="${data.malf||''}"></td>
      <td><button class="btn">✕</button></td>
    `;
    tr.querySelectorAll('input').forEach(i=> i.addEventListener('input', persist));
    tr.querySelector('button').addEventListener('click', ()=>{ tr.remove(); persist(); });
    tb.appendChild(tr);
  }

  // Initialize skills
  BASE_SKILLS.forEach(([name, base]) => skillsTbody.appendChild(skillRow(name, base)));

  // Adders for variant skills
  document.getElementById('add-art').addEventListener('click', ()=>{
    skillsTbody.appendChild(skillRow('Art/Craft ( )', 5)); persist();
  });
  document.getElementById('add-lang').addEventListener('click', ()=>{
    skillsTbody.appendChild(skillRow('Language (Other) ( )', 1)); persist();
  });
  document.getElementById('add-sci').addEventListener('click', ()=>{
    skillsTbody.appendChild(skillRow('Science ( )', 1)); persist();
  });
  document.getElementById('add-fight').addEventListener('click', ()=>{
    skillsTbody.appendChild(skillRow('Fighting ( )', 25)); persist();
  });

  // Weapons
  document.getElementById('add-weapon').addEventListener('click', ()=> addWeaponRow());

  // Inputs wiring
  ['name','occupation','residence','birthplace','age','pronoun','dodge','mov','build','db','hp_current','hp_max','mp_current','mp_max','luck_current','luck_start','san_current','san_max'].forEach(id=>{
    const el = byId(id); if (!el) return; el.addEventListener('input', ()=>{
      if (id==='dodge') el.dataset.manual='1';
      persist();
    });
  });

  ['flag_temp_ins','flag_indef_ins','flag_major_wound','flag_dying'].forEach(id=> byId(id).addEventListener('change', persist));

  // Character listeners -> derived updates
  CHAR_LIST.forEach(({key})=>{
    const input = byId(key);
    input.addEventListener('input', ()=>{ updateDerived(); persist(); });
  });

  function updateAllSkillHalves(){
    document.querySelectorAll('#skills tbody tr').forEach(tr=>{
      const baseInput = tr.querySelector('.skill-base');
      const formula = baseInput.getAttribute('data-formula');
      if (formula && (formula==='DEX/2' || formula==='EDU')){
        baseInput.value = baseFormulaToNumber(formula);
      }
      recomputeSkillRow(tr);
    });
  }

  // === Persistence ===
  function serialize(){
    const data = {};
    // header
    ['name','occupation','residence','birthplace','age','pronoun'].forEach(id=> data[id]=byId(id).value||'');
    // chars
    data.chars = {}; CHAR_LIST.forEach(({key}) => data.chars[key] = num(key));
    // derived
    ['dodge','mov','build','db','hp_current','hp_max','mp_current','mp_max','luck_current','luck_start','san_current','san_max'].forEach(id=> data[id]=byId(id).value||'');
    // flags
    ['flag_temp_ins','flag_indef_ins','flag_major_wound','flag_dying'].forEach(id=> data[id]=byId(id).checked);
    // skills
    data.skills = Array.from(document.querySelectorAll('#skills tbody tr')).map(tr=>({
      name: tr.querySelector('.skill-name').value,
      base: parseInt(tr.querySelector('.skill-base').value,10)||0,
      now: parseInt(tr.querySelector('.skill-now').value,10)||0,
      tick: tr.querySelector('.skill-tick').checked,
      formula: tr.querySelector('.skill-base').getAttribute('data-formula')||null
    }));
    // weapons
    data.weapons = Array.from(document.querySelectorAll('#weapons tbody tr')).map(tr=>{
      const [name,skill,damage,range,attacks,ammo,malf] = Array.from(tr.querySelectorAll('input')).map(i=>i.value);
      return { name, skill, damage, range, attacks, ammo, malf };
    });
    return data;
  }

  function persist(){
    localStorage.setItem(storageKey, JSON.stringify(serialize()));
  }

  function hydrate(data){
    if (!data) return;
    // header
    ['name','occupation','residence','birthplace','age','pronoun'].forEach(id=> { if (data[id]!=null) byId(id).value=data[id]; });
    // chars
    if (data.chars){ CHAR_LIST.forEach(({key})=>{ if (data.chars[key]!=null) byId(key).value = data.chars[key]; }); }
    // derived/simple
    ['dodge','mov','build','db','hp_current','hp_max','mp_current','mp_max','luck_current','luck_start','san_current','san_max'].forEach(id=>{ if (data[id]!=null) byId(id).value = data[id]; });
    // flags
    ['flag_temp_ins','flag_indef_ins','flag_major_wound','flag_dying'].forEach(id=>{ if (data[id]!=null) byId(id).checked = !!data[id]; });
    // skills
    if (Array.isArray(data.skills)){
      skillsTbody.innerHTML = '';
      data.skills.forEach(s=>{
        const tr = skillRow(s.name, s.formula ? s.formula : s.base);
        skillsTbody.appendChild(tr);
        tr.querySelector('.skill-base').value = s.base;
        tr.querySelector('.skill-now').value = s.now;
        tr.querySelector('.skill-tick').checked = !!s.tick;
        recomputeSkillRow(tr,false);
      });
    }
    // weapons
    if (Array.isArray(data.weapons)){
      const tb = document.querySelector('#weapons tbody');
      tb.innerHTML = '';
      data.weapons.forEach(addWeaponRow);
    }
    updateDerived();
  }

  // buttons
  document.getElementById('print').addEventListener('click', ()=> window.print());
  document.getElementById('reset').addEventListener('click', ()=>{
    if (confirm('Очистить все поля?')){ localStorage.removeItem(storageKey); window.location.reload(); }
  });

  document.getElementById('export').addEventListener('click', ()=>{
    const blob = new Blob([JSON.stringify(serialize(), null, 2)], {type: 'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `coc7_${(byId('name').value||'investigator').replace(/\s+/g,'_')}.json`;
    a.click();
  });
  document.getElementById('import').addEventListener('click', ()=> byId('importFile').click());
  document.getElementById('importFile').addEventListener('change', (e)=>{
    const file = e.target.files[0]; if (!file) return;
    const reader = new FileReader();
    reader.onload = ()=>{ try{ const data = JSON.parse(reader.result); hydrate(data); persist(); } catch(err){ alert('Не удалось импортировать JSON'); } };
    reader.readAsText(file);
  });

  // Initial weapons rows
  addWeaponRow(); addWeaponRow();

  // Hydrate from localStorage or defaults
  const saved = localStorage.getItem(storageKey);
  if (saved){ try { hydrate(JSON.parse(saved)); } catch(e){ console.warn('save corrupted'); } }
  updateDerived();
  </script>
</body>
</html>